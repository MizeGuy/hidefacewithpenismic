<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lightning Chase Survival</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        html, body {
            width: 100%;
            height: 100%;
            background: url('main/brill.png') no-repeat center center;
            background-size: cover;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }
        #Canvas {
            position: relative;
            width: 100%;
            height: 100%;
            cursor: default;
            display: none;
        }

        #StartScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
        }
        #StartButton, #TutorialButton {
            background: #00ffff;
            border: none;
            padding: 2vh 4vw;
            border-radius: 10px;
            cursor: pointer;
            font-size: 2vw;
            color: #1a1a2e;
            margin: 1vh;
            transition: transform 0.2s;
        }
        #StartButton:hover, #TutorialButton:hover {
            transform: scale(1.05);
        }
        #Tutorial {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9);
            color: #00ffff;
            padding: 2vw;
            border-radius: 10px;
            font-size: 1.5vw;
            display: none;
            z-index: 1001;
            max-width: 50vw;
            text-align: center;
        }

        #ManaBarContainer {
            position: absolute;
            top: 2vh;
            left: 50%;
            transform: translateX(-50%);
            width: 40vw;
            height: 2vh;
            background: rgba(0,0,0,0.7);
            border: 2px solid #00ffff;
            border-radius: 10px;
            overflow: hidden;
            z-index: 200;
        }
        #ManaBar {
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, #00ffff, #00b7eb);
            transition: width 0.3s ease;
            box-shadow: 0 0 8px #00ffff;
        }

        #Header {
            position: absolute;
            top: 5vh;
            left: 50%;
            transform: translateX(-50%);
            color: #00ffff;
            font-weight: bold;
            font-size: 1.2vw;
            text-shadow: 0 0 4px #00ffff;
            z-index: 9999;
        }

        #Birdy {
            position: absolute;
            top: 40%;
            left: 20%;
            width: 8vw;
            height: 4.5vh;
            max-width: 100px;
            max-height: 56px;
            min-width: 30px;
            min-height: 16px;
            background-image: url('main/player.avif');
            background-size: cover;
            z-index: 150;
            transition: transform 0.1s ease;
        }
        .stunned {
            filter: brightness(0.5) blur(1px);
            animation: shake 0.2s infinite;
        }
        @keyframes shake {
            0% { transform: translate(1px, 0.5px); }
            50% { transform: translate(-1px, -0.5px); }
            100% { transform: translate(1px, 0.5px); }
        }

        .Coin {
            position: absolute;
            width: 4vw;
            height: 3vh;
            max-width: 60px;
            max-height: 45px;
            background-image: url('main/boostlogo.png');
            background-size: cover;
            left: 100%;
            z-index: 140;
            animation: CoinMovement 5s linear, glow 1s infinite alternate;
        }
        @keyframes glow {
            from { box-shadow: 0 0 3px gold; }
            to { box-shadow: 0 0 8px gold; }
        }

        .LightningBolt {
            position: absolute;
            width: 2vw;
            height: 10vh;
            background: linear-gradient(0deg, transparent, #00b7eb, transparent);
            opacity: 0.5;
            z-index: 145;
            animation: boltFade 1s linear;
            box-shadow: 0 0 5px #00b7eb;
        }
        .LightningBolt span {
            position: absolute;
            top: -2vh;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            font-weight: bold;
            text-decoration: underline;
            font-size: 1vw;
            text-shadow: -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000;
        }
        .LightningWall {
            position: absolute;
            width: 6vw;
            height: 100vh;
            left: 100%;
            background: repeating-linear-gradient(0deg, #00ffff 0%, #00ffff 15%, transparent 15%, transparent 30%);
            opacity: 0.6;
            z-index: 148;
            animation: WallMovement 5s linear;
            box-shadow: 0 0 10px #00ffff;
        }
        @keyframes WallMovement { from { left: 100%; } to { left: -10%; } }
        @keyframes CoinMovement { from { left: 100%; } to { left: -10%; } }
        @keyframes boltFade { 0% { opacity: 0.5; } 100% { opacity: 0; } }

        #CurrentScoreCard {
            position: absolute;
            left: 2vw;
            top: 2vh;
            font-size: 1.5vw;
            color: #00ffff;
            text-shadow: 0 0 4px #00ffff;
            z-index: 50;
            pointer-events: none;
        }

        #LostScoreScreen {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            padding: 1.5vw;
            background: rgba(0,0,0,0.8);
            border: 2px solid #00ffff;
            border-radius: 8px;
            text-align: center;
            display: none;
            font-size: 1.5vw;
            color: #00ffff;
            z-index: 150;
            width: 30vw;
            max-width: 400px;
            box-shadow: 0 0 15px #00ffff;
        }
        #FinalScore, #BestScore {
            font-weight: bold;
            font-size: 2vw;
            text-shadow: 0 0 8px #00ffff;
        }
        #ResetButton {
            background: #00ffff;
            border: none;
            padding: 0.8vh 2vw;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.2vw;
            color: #1a1a2e;
            transition: transform 0.2s;
        }
        #ResetButton:hover {
            transform: scale(1.05);
        }

        #PauseButton {
            position: absolute;
            top: 2vh;
            right: 1vw;
            width: 2.5vw;
            max-width: 35px;
            background: #00ffff;
            border-radius: 0.4vw;
            font-size: 1.5vw;
            text-align: center;
            z-index: 50;
            cursor: pointer;
            padding: 0.4vh 0;
            box-shadow: 0 0 8px #00ffff;
            transition: transform 0.2s;
        }
        #PauseButton:hover {
            transform: scale(1.1);
        }

        #Chaser {
            position: absolute;
            top: 40%;
            left: 10%; /* Closer to player */
            width: 10vw;
            height: 10vh;
            max-width: 125px;
            max-height: 125px;
            background-image: url('main/chaser.JPG');
            background-size: cover;
            z-index: 100;
            filter: drop-shadow(0 0 8px #ff00ff);
        }

        .Kolkar {
            position: absolute;
            width: 10vw;
            height: 8.75vh;
            max-width: 125px;
            max-height: 109px;
            background-image: url('main/kolkar.png');
            background-size: cover;
            left: 100%;
            z-index: 160;
            animation: KolkarMovement 5s linear;
        }
        @keyframes KolkarMovement { from { left: 100%; } to { left: -15%; } }
        .paused { animation-play-state: paused; }
    </style>
</head>
<body>
    <div id="StartScreen">
        <button id="StartButton">Start Game</button>
        <button id="TutorialButton">Tutorial</button>
    </div>
    <div id="Tutorial">
        Click to jump<br>
        Space to reset<br>
        P to pause<br>
        Collect coins to heal<br>
        Dodge frost bolts and walls<br>
        Survive as long as you can!<br>
        (Click anywhere to close)
    </div>
    <div id="ManaBarContainer"><div id="ManaBar"></div></div>
    <div id="Header">Made By TheMizeGuy</div>
    <div id="Canvas">
        <div id="CurrentScoreCard" class="noSelect"><span id="CurrentScore">0</span></div>
        <div id="LostScoreScreen" class="noSelect">
            <span>Distance Survived</span><br><span id="FinalScore">0</span><br>
            <span>Best</span><br><span id="BestScore">0</span><br><br>
            <button id="ResetButton" type="button">Reset</button>
        </div>
        <div id="Birdy"></div>
        <div id="PauseButton" class="noSelect">||</div>
        <div id="Chaser"></div>
    </div>

    <script src="main/jquery.min.js"></script>
    <script>
        $(function() {
            const canvasObject = $('#Canvas');
            let gameLoopIntervalID = 0;
            let Paused = true;
            let Lost = false;
            let CurrentScore = 0;
            let gameLoopCounter = 0;
            const basePlayerSpeed = 0.25;
            let baseChaseSpeed = 0.2;
            const maxMana = 100;
            let currentMana = maxMana;
            let stunned = false;
            let stunDuration = 0;
            let frostBoltCounter = 0;

            // Audio setup
            const coinSound = new Audio('main/coin.mp3'); coinSound.volume = 0.1;
            const lightningSound = new Audio('main/lightning.mp3'); lightningSound.volume = 0.3;
            const hitSound = new Audio('main/hit.mp3'); hitSound.volume = 0.4;
            const deathSound = new Audio('main/death.mp3'); deathSound.volume = 0.7;
            const jammerSound = new Audio('main/jammer.mp3'); jammerSound.loop = true;
            const ohSound = new Audio('main/oh.mp3'); ohSound.volume = 0.2;
            let jammerFadeInterval = null;

            // Player object
            const Birdy = {
                selectorObject: $('#Birdy'),
                gravVeloc: 0,
                gravAccel: 0.35,
                terminalVelocity: 12,
                reset() {
                    this.gravVeloc = 0;
                    stunned = false;
                    currentMana = maxMana;
                    this.selectorObject.removeClass('stunned').css({ top: '40%', left: '20%' });
                    updateManaBar();
                },
                fall() {
                    if (!stunned && !Paused) {
                        const newTop = this.getTopPercent() + this.gravVeloc;
                        this.selectorObject.css('top', clamp(newTop, 0, 90) + '%');
                        this.gravVeloc = Math.min(this.gravVeloc + this.gravAccel, this.terminalVelocity);
                    }
                },
                jump() {
                    if (Paused || stunned) return;
                    this.gravVeloc = -4;
                },
                move() {
                    if (!stunned && !Paused) {
                        const currentLeft = this.getLeftPercent();
                        this.selectorObject.css('left', (currentLeft + basePlayerSpeed) + '%');
                    }
                },
                getTopPercent() { return parseFloat(this.selectorObject.css('top')) / $(window).height() * 100; },
                getLeftPercent() { return parseFloat(this.selectorObject.css('left')) / $(window).width() * 100; }
            };

            // Start screen handlers
            $('#StartButton').on('click', () => {
                $('#StartScreen').hide();
                canvasObject.show();
                startGame();
            });
            $('#TutorialButton').on('click', () => $('#Tutorial').show());
            $(document).on('click', e => {
                if ($(e.target).closest('#Tutorial').length && !$(e.target).is('#TutorialButton')) {
                    $('#Tutorial').hide();
                }
            });

            // Game state management
            function startGame() {
                if (Lost) return;
                gameLoopIntervalID = setInterval(gameLoop, 30);
                $('.Coin, .LightningWall, .Kolkar').removeClass('paused');
                $('#PauseButton').text('||');
                Paused = false;
                startJammerFade();
            }

            function pauseGame() {
                clearInterval(gameLoopIntervalID);
                $('.Coin, .LightningWall, .Kolkar').addClass('paused');
                $('#PauseButton').text('▶');
                Paused = true;
                jammerSound.pause();
            }

            function togglePause() { Paused ? startGame() : pauseGame(); }

            function endGame() {
                Lost = true;
                pauseGame();
                const highScore = Math.max(CurrentScore, parseInt(getCookie('HighScore') || 0));
                setCookie('HighScore', highScore, 9999);
                $('#FinalScore').text(CurrentScore);
                $('#BestScore').text(highScore);
                $('#LostScoreScreen').fadeIn(300);
                deathSound.play();
                clearInterval(jammerFadeInterval);
                jammerSound.pause();
            }

            function resetGame() {
                pauseGame();
                $('.Coin, .LightningBolt, .LightningWall, .Kolkar').remove();
                Lost = false;
                CurrentScore = 0;
                gameLoopCounter = 0;
                baseChaseSpeed = 0.2;
                frostBoltCounter = 0;
                $('#Chaser').css({ left: '10%', top: '40%' }); // Reset closer to player
                Birdy.reset();
                $('#LostScoreScreen').fadeOut(300);
                nextLightningWallSpawn = 100;
                nextKolkarSpawn = 150;
                clearInterval(jammerFadeInterval);
                jammerSound.currentTime = 0;
                startGame();
            }

            // Audio management
            function startJammerFade() {
                jammerSound.volume = 0;
                jammerSound.play();
                const fadeDuration = 20000;
                const maxVolume = 0.2;
                const steps = 100;
                const stepTime = fadeDuration / steps;
                const volIncrement = maxVolume / steps;
                
                clearInterval(jammerFadeInterval);
                jammerFadeInterval = setInterval(() => {
                    if (Paused || Lost) {
                        clearInterval(jammerFadeInterval);
                        return;
                    }
                    const newVol = Math.min(jammerSound.volume + volIncrement, maxVolume);
                    jammerSound.volume = newVol;
                    if (newVol >= maxVolume) clearInterval(jammerFadeInterval);
                }, stepTime);
            }

            // Game elements
            function updateManaBar() {
                $('#ManaBar').css('width', (currentMana / maxMana * 100) + '%');
                if (currentMana <= 0) endGame();
            }

            function addCoin() {
                $('<div/>').addClass('Coin').css({ top: 20 + Math.random() * 50 + '%' }).appendTo(canvasObject);
            }

            function addLightningBolt() {
                const chaserTop = parseFloat($('#Chaser').css('top'));
                const label = frostBoltCounter % 2 === 0 ? 'R1' : 'OOM';
                frostBoltCounter++;
                const bolt = $('<div/>').addClass('LightningBolt')
                    .css({
                        left: $('#Chaser').offset().left + $('#Chaser').width(),
                        top: chaserTop + (Math.random() - 0.5) * 30 + '%'
                    })
                    .append(`<span>${label}</span>`)
                    .appendTo(canvasObject);
                bolt.animate({ left: Birdy.selectorObject.offset().left + (Math.random() - 0.5) * 200 }, 1000, 'linear', function() { $(this).remove(); });
                lightningSound.currentTime = 0;
                lightningSound.play();
            }

            let nextLightningWallSpawn = 100;
            function addLightningWall() {
                const gapHeight = 35;
                const gapTop = Math.random() * (65 - gapHeight) + 10;
                const wall = $('<div/>').addClass('LightningWall').css('top', '0%').appendTo(canvasObject);
                wall.data({ gapTop, gapHeight });
                lightningSound.currentTime = 0;
                lightningSound.play();
            }

            let nextKolkarSpawn = 150;
            function addKolkar() {
                $('<div/>').addClass('Kolkar').css('top', 10 + Math.random() * 60 + '%').appendTo(canvasObject);
            }

            function updateChaser() {
                if (!Lost && !Paused) {
                    const playerLeft = Birdy.getLeftPercent();
                    const chaseLeft = parseFloat($('#Chaser').css('left')) / $(window).width() * 100;
                    const distanceFactor = Math.max(0, 1 - (playerLeft - chaseLeft) / 50);
                    const adjustedChaseSpeed = baseChaseSpeed * (0.7 + 0.3 * distanceFactor);
                    
                    const newChaseLeft = chaseLeft + adjustedChaseSpeed;
                    const birdTop = Birdy.getTopPercent();
                    const chaseTop = parseFloat($('#Chaser').css('top'));
                    const diff = birdTop - chaseTop;
                    
                    $('#Chaser').css({
                        left: newChaseLeft + '%',
                        top: (chaseTop + diff * 0.05) + '%'
                    });

                    if (isIntersecting(Birdy.selectorObject, $('#Chaser'))) endGame();
                }
            }

            // Main game loop
            function gameLoop() {
                if (stunDuration > 0) {
                    stunDuration--;
                    if (stunDuration <= 0) Birdy.selectorObject.removeClass('stunned');
                }

                Birdy.move();
                Birdy.fall();
                updateChaser();
                CurrentScore = Math.floor(gameLoopCounter / 10);
                $('#CurrentScore').text(CurrentScore);

                if (gameLoopCounter % 50 === 0) addCoin();
                if (gameLoopCounter % 8 === 0) addLightningBolt(); // Much more frequent frost bolts
                if (gameLoopCounter >= nextLightningWallSpawn) {
                    addLightningWall();
                    nextLightningWallSpawn = gameLoopCounter + 120 + Math.random() * 60;
                }
                if (gameLoopCounter >= nextKolkarSpawn) {
                    addKolkar();
                    nextKolkarSpawn = gameLoopCounter + 100 + Math.random() * 50;
                }

                checkCollisions();
                currentMana -= 0.08;
                updateManaBar();
                gameLoopCounter++;
            }

            // Collision detection
            function checkCollisions() {
                $('.Coin').each(function() {
                    if (isIntersecting(Birdy.selectorObject, $(this))) {
                        $(this).remove();
                        currentMana = Math.min(maxMana, currentMana + 20);
                        coinSound.currentTime = 0;
                        coinSound.play();
                    }
                });

                $('.LightningBolt').each(function() {
                    if (isIntersecting(Birdy.selectorObject, $(this)) && !stunned) {
                        currentMana -= 5; // Reduced damage from frost bolts
                        stunned = true;
                        stunDuration = 50; // 1.5 seconds at 30ms per frame (30 * 1.5 = 45, rounded to 50)
                        Birdy.selectorObject.addClass('stunned');
                        hitSound.play();
                        ohSound.currentTime = 0;
                        ohSound.play();
                        $(this).remove();
                    }
                });

                $('.LightningWall').each(function() {
                    if (isIntersecting(Birdy.selectorObject, $(this))) {
                        const birdTop = Birdy.getTopPercent();
                        const { gapTop, gapHeight } = $(this).data();
                        if (birdTop < gapTop || birdTop > gapTop + gapHeight) {
                            currentMana -= 30;
                            stunned = true;
                            stunDuration = 50; // 1.5 seconds
                            Birdy.selectorObject.addClass('stunned');
                            hitSound.play();
                            ohSound.currentTime = 0;
                            ohSound.play();
                        }
                    }
                });

                $('.Kolkar').each(function() {
                    if (isIntersecting(Birdy.selectorObject, $(this))) {
                        currentMana -= 34; // 15% less than 40 (40 * 0.85 = 34)
                        stunned = true;
                        stunDuration = 50; // 1.5 seconds
                        Birdy.selectorObject.addClass('stunned');
                        hitSound.play();
                        ohSound.currentTime = 0;
                        ohSound.play();
                        $(this).remove();
                    }
                });

                $('.Coin, .LightningBolt, .LightningWall, .Kolkar').filter((_, el) => $(el).offset().left < -$(el).width()).remove();
            }

            // Utility functions
            function isIntersecting(obj1, obj2) {
                const o1 = obj1[0].getBoundingClientRect();
                const o2 = obj2[0].getBoundingClientRect();
                return !(o1.bottom < o2.top || o1.top > o2.bottom || o1.right < o2.left || o1.left > o2.right);
            }

            function clamp(value, min, max) {
                return Math.max(min, Math.min(max, value));
            }

            function setCookie(name, value, days) {
                const d = new Date();
                d.setTime(d.getTime() + (days * 24 * 60 * 60 * 1000));
                document.cookie = `${name}=${value}; expires=${d.toUTCString()}; path=/`;
            }

            function getCookie(name) {
                return document.cookie.split('; ').reduce((acc, cookie) => {
                    const [key, val] = cookie.split('=');
                    return key === name ? val : acc;
                }, '');
            }

            // Event handlers
            canvasObject.on('mousedown', e => {
                e.preventDefault();
                Birdy.jump();
            });

            $(document).on('keydown', e => {
                if (e.which === 32) {
                    if (Lost) resetGame();
                }
                if (e.which === 80) togglePause();
            });

            $('#PauseButton').on('mousedown', e => {
                e.stopPropagation();
                e.preventDefault();
                togglePause();
            });

            $('#ResetButton').on('click', resetGame);
        });
    </script>
</body>
</html>
